{% extends 'base.html.twig' %}

{% block title %}Centre de Commandement - CampusFlow{% endblock %}

{% block body %}
<!-- 
    THEME: Cool Professional
    - Background: Slate-50 (#F8FAFC) - Cool Off-White
    - Text: Midnight Blue (#0F172A)
    - Accents: Gold (#D97706) & Blue (#3A86FF)
-->
<div class="min-h-screen bg-slate-50 text-[#0F172A] px-4 py-12 relative overflow-hidden font-sans">
    
    <!-- Background Elements (Cooler Tones) -->
    <div class="absolute -top-[10%] -left-[10%] w-[50%] h-[50%] bg-[#3A86FF]/5 rounded-full blur-[120px] pointer-events-none"></div>
    <div class="absolute bottom-0 right-0 w-[40%] h-[40%] bg-[#D97706]/5 rounded-full blur-[120px] pointer-events-none"></div>

    <!-- Header -->
    <div class="max-w-7xl mx-auto mb-16 relative">
        <div class="flex flex-col md:flex-row justify-between items-end gap-6">
            <div>
                <span class="text-[#D97706] font-bold tracking-widest uppercase text-xs mb-2 block">Administration</span>
                <h1 class="text-5xl md:text-6xl font-heading font-black text-[#0F172A] tracking-tight leading-none">
                    Centre de <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#D97706] to-[#F59E0B]">Commandement</span>.
                </h1>
            </div>
            <div class="flex items-center gap-3 bg-white/50 backdrop-blur-sm px-6 py-3 rounded-full border border-[#0F172A]/5 shadow-sm">
                <span class="w-2 h-2 rounded-full bg-[#10B981] animate-pulse"></span>
                <p class="text-[#0F172A]/70 text-sm font-bold tracking-wide">Système Opérationnel</p>
            </div>
        </div>
    </div>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto">
        
        <!-- 1. KPI Cards Grid -->
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-5 mb-12">
            <!-- Étudiants -->
            <div class="group bg-white rounded-[2rem] p-6 shadow-[0_4px_20px_rgba(15,23,42,0.03)] border border-slate-100 hover:-translate-y-2 transition-transform duration-500">
                <div class="w-12 h-12 rounded-2xl bg-[#3A86FF]/10 text-[#3A86FF] flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Effectifs</p>
                <p class="text-4xl font-black text-[#0F172A] tracking-tighter">{{ stats.students }}</p>
            </div>

            <!-- Classes -->
            <div class="group bg-white rounded-[2rem] p-6 shadow-[0_4px_20px_rgba(15,23,42,0.03)] border border-slate-100 hover:-translate-y-2 transition-transform duration-500">
                <div class="w-12 h-12 rounded-2xl bg-[#10B981]/10 text-[#10B981] flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                    <i class="fas fa-layer-group"></i>
                </div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Classes</p>
                <p class="text-4xl font-black text-[#0F172A] tracking-tighter">{{ stats.classes }}</p>
            </div>

            <!-- Enseignants -->
            <div class="group bg-white rounded-[2rem] p-6 shadow-[0_4px_20px_rgba(15,23,42,0.03)] border border-slate-100 hover:-translate-y-2 transition-transform duration-500">
                <div class="w-12 h-12 rounded-2xl bg-[#D97706]/10 text-[#D97706] flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Mentors</p>
                <p class="text-4xl font-black text-[#0F172A] tracking-tighter">{{ stats.teachers }}</p>
            </div>

            <!-- Séances -->
            <div class="group bg-white rounded-[2rem] p-6 shadow-[0_4px_20px_rgba(15,23,42,0.03)] border border-slate-100 hover:-translate-y-2 transition-transform duration-500">
                <div class="w-12 h-12 rounded-2xl bg-[#8B5CF6]/10 text-[#8B5CF6] flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                    <i class="fas fa-clock"></i>
                </div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Séances</p>
                <p class="text-4xl font-black text-[#0F172A] tracking-tighter">{{ stats.schedules }}</p>
            </div>

            <!-- Notes -->
            <div class="group bg-white rounded-[2rem] p-6 shadow-[0_4px_20px_rgba(15,23,42,0.03)] border border-slate-100 hover:-translate-y-2 transition-transform duration-500">
                <div class="w-12 h-12 rounded-2xl bg-[#E11D48]/10 text-[#E11D48] flex items-center justify-center text-xl mb-4 group-hover:scale-110 transition-transform">
                    <i class="fas fa-star"></i>
                </div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Notes</p>
                <p class="text-4xl font-black text-[#0F172A] tracking-tighter">{{ stats.grades }}</p>
            </div>
        </div>

        <!-- 2. Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            
            <!-- Performance Chart -->
            <div class="lg:col-span-2 bg-white rounded-[2.5rem] shadow-[0_20px_40px_-10px_rgba(15,23,42,0.05)] border border-slate-100 p-8 relative overflow-hidden">
                <div class="flex items-start justify-between mb-8">
                    <div>
                        <h3 class="text-2xl font-black text-[#0F172A] tracking-tight">Indice de Performance</h3>
                        <p class="text-slate-400 font-medium">Évolution de la moyenne générale (0-20)</p>
                    </div>
                    <div class="text-right">
                        <span class="block text-3xl font-black text-[#D97706]">{{ success.successRate }}%</span>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Réussite Globale</span>
                    </div>
                </div>
                
                <div class="w-full h-[350px]">
                    <canvas id="gradesChart"></canvas>
                </div>
            </div>

            <!-- Distribution Chart -->
            <div class="bg-white rounded-[2.5rem] shadow-[0_20px_40px_-10px_rgba(15,23,42,0.05)] border border-slate-100 p-8 flex flex-col justify-between">
                <div>
                    <h3 class="text-2xl font-black text-[#0F172A] tracking-tight mb-2">Répartition</h3>
                    <p class="text-slate-400 font-medium text-sm">Segmentation des résultats</p>
                </div>
                <div class="w-full h-[250px] relative mt-4">
                    <canvas id="distributionChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-2xl font-black text-[#0F172A]">2026</span>
                    </div>
                </div>
                <div class="mt-6 flex justify-center gap-4">
                     <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-[#10B981]"></span>
                        <span class="text-xs font-bold text-slate-500">Apex</span>
                     </div>
                     <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full bg-[#D97706]"></span>
                        <span class="text-xs font-bold text-slate-500">Standard</span>
                     </div>
                </div>
            </div>
        </div>

        <!-- 3. Recent Students Table -->
        <div class="bg-white rounded-[2.5rem] shadow-[0_20px_40px_-10px_rgba(15,23,42,0.05)] border border-slate-100 overflow-hidden">
            <div class="px-8 py-8 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <h3 class="text-2xl font-black text-[#0F172A] tracking-tight flex items-center gap-3">
                    <span class="w-2 h-8 bg-[#D97706] rounded-full"></span>
                    Inscriptions Récentes
                </h3>
                <button class="px-6 py-2.5 rounded-xl border-2 border-slate-200 text-[#0F172A] font-bold text-xs uppercase tracking-widest hover:bg-[#0F172A] hover:text-white transition-all">
                    Voir Tout
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50">
                            <th class="px-8 py-6 text-xs font-black text-slate-400 uppercase tracking-widest">Étudiant</th>
                            <th class="px-8 py-6 text-xs font-black text-slate-400 uppercase tracking-widest">Matricule</th>
                            <th class="px-8 py-6 text-xs font-black text-slate-400 uppercase tracking-widest">Classe</th>
                            <th class="px-8 py-6 text-xs font-black text-slate-400 uppercase tracking-widest text-right">Inscription</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for student in recentStudents %}
                            <tr class="hover:bg-slate-50 transition-colors group">
                                <td class="px-8 py-5">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 rounded-full bg-[#0F172A] text-white flex items-center justify-center font-bold text-sm">
                                            {{ student.fullName|first }}
                                        </div>
                                        <div>
                                            <p class="font-bold text-[#0F172A] group-hover:text-[#D97706] transition-colors">{{ student.fullName }}</p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-8 py-5 font-mono text-sm font-bold text-slate-500">{{ student.cne }}</td>
                                <td class="px-8 py-5">
                                    <span class="px-3 py-1 rounded-lg bg-[#D97706]/10 text-[#D97706] text-xs font-bold uppercase tracking-wide">
                                        {{ student.classe ? student.classe.name : 'N/A' }}
                                    </span>
                                </td>
                                <td class="px-8 py-5 text-right font-bold text-slate-500 text-sm">
                                    {{ student.enrollmentDate ? student.enrollmentDate|date('d/m/Y') : '-' }}
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4" class="px-8 py-12 text-center text-slate-400 font-medium">Aucune donnée récente.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Footer Info -->
        <div class="mt-12 text-center">
             <p class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em]">&copy; 2026 CampusFlow Système de Gestion</p>
        </div>

    </div>
</div>


<script>
    (function() {
        // Use a persistent object to store chart instances across Turbo loads
        window.dashboardCharts = window.dashboardCharts || {};

        window.pageInit = function() {
            console.log('Initializing Dashboard Charts...');
            
            // --- Chart 1: PERFORMANCE CHART ---
            try {
                const monthlyData = {{ monthlyAverages|json_encode|raw }};
                const labels = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'];
                const dataPoints = labels.map((_, idx) => monthlyData[idx + 1] ?? null);

                const gradesCanvas = document.getElementById('gradesChart');
                if (gradesCanvas) {
                    // Destroy existing instance if it exists
                    if (window.dashboardCharts.grades) {
                        window.dashboardCharts.grades.destroy();
                        window.dashboardCharts.grades = null;
                    }

                    window.dashboardCharts.grades = new Chart(gradesCanvas, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Moyenne',
                                data: dataPoints,
                                borderColor: '#D97706', 
                                borderWidth: 4,
                                spanGaps: true, 
                                backgroundColor: (context) => {
                                    const ctx = context.chart.ctx;
                                    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                                    gradient.addColorStop(0, 'rgba(217, 119, 6, 0.15)'); 
                                    gradient.addColorStop(1, 'rgba(217, 119, 6, 0)');
                                    return gradient;
                                },
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#FFFFFF', 
                                pointBorderColor: '#D97706',     
                                pointBorderWidth: 3,
                                pointRadius: 6,
                                pointHoverRadius: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#0F172A',
                                    titleColor: '#F59E0B',
                                    bodyColor: '#FFF',
                                    padding: 15,
                                    displayColors: false,
                                    titleFont: { size: 14, family: 'sans-serif' },
                                    bodyFont: { size: 16, weight: 'bold' },
                                    callbacks: {
                                        label: (ctx) => `Moyenne : ${ctx.raw} / 20`
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 20, 
                                    grid: {
                                        color: 'rgba(15, 23, 42, 0.05)',
                                        borderDash: [5, 5]
                                    },
                                    ticks: {
                                        color: '#0F172A', 
                                        font: { size: 14, weight: 'bold' },
                                        padding: 10
                                    }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: {
                                        color: '#64748b',
                                        font: { size: 12, weight: 'bold' }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error initializing Performance Chart:', e);
            }

            // --- Chart 2: DISTRIBUTION CHART ---
            try {
                const distributionCanvas = document.getElementById('distributionChart');
                if (distributionCanvas) {
                    // Destroy existing instance if it exists
                    if (window.dashboardCharts.distribution) {
                        window.dashboardCharts.distribution.destroy();
                        window.dashboardCharts.distribution = null;
                    }

                    window.dashboardCharts.distribution = new Chart(distributionCanvas, {
                        type: 'doughnut',
                        data: {
                            labels: ['Apex (>16)', 'Distinction (14-16)', 'Standard (10-14)', 'Risk (<10)'],
                            datasets: [{
                                data: [25, 30, 35, 10], 
                                backgroundColor: ['#10B981', '#3A86FF', '#D97706', '#E11D48'],
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#0F172A',
                                    bodyFont: { size: 14 }
                                }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error('Error initializing Distribution Chart:', e);
            }
        };
    })();
</script>
{% endblock %}
