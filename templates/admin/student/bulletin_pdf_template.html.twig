<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Bulletin - {{ student.fullName }}</title>
    <style>
        @page { margin: 1cm; }
        body { font-family: 'DejaVu Sans', sans-serif; font-size: 11px; color: #000; line-height: 1.4; }
        .header-table { width: 100%; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .student-box-table { width: 100%; border: 1px solid #000; padding: 12px; margin-bottom: 20px; background-color: #f8fafc; }
        table.grades-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        table.grades-table th, table.grades-table td { border: 1px solid #000; padding: 8px; text-align: left; }
        table.grades-table th { background-color: #f1f5f9; text-align: center; font-weight: bold; text-transform: uppercase; font-size: 9px; }
        .center { text-align: center; }
        .right { text-align: right; }
        .avg-row { background-color: #eff6ff; font-weight: bold; font-size: 13px; }
        .bold { font-weight: bold; }
    </style>
</head>
<body>
    <table class="header-table">
        <tr>
            <td colspan="2" style="text-align: center;">
                <h3 style="margin:0; text-transform:uppercase; font-size: 14px; letter-spacing: 2px;">Royaume du Maroc</h3>
                <h4 style="margin:5px 0; text-transform:uppercase; font-size: 11px;">Ministère de l'Éducation Nationale</h4>
            </td>
        </tr>
        <tr>
            <td style="padding-top: 20px; font-size: 10px;">
                <strong>Établissement :</strong> CampusFlow Academy<br>
                <strong>Année Scolaire :</strong> {{ student.classe.academicYear }}
            </td>
            <td style="padding-top: 20px; text-align: right; font-size: 10px; vertical-align: bottom;">
                <strong>Ville :</strong> Casablanca
            </td>
        </tr>
    </table>

    <table class="student-box-table">
        <tr>
            <td style="width: 50%;">
                <p style="margin: 0 0 5px 0;"><strong>Nom & Prénom :</strong> {{ student.lastName|upper }} {{ student.firstName }}</p>
                <p style="margin: 0 0 5px 0;"><strong>N° CNE :</strong> {{ student.cne }}</p>
                <p style="margin: 0;"><strong>Date de Naissance :</strong> {{ student.birthDate|date('d/m/Y') }}</p>
            </td>
            <td style="width: 50%; text-align: right; vertical-align: top;">
                <p style="margin: 0 0 5px 0;"><strong>Classe :</strong> {{ student.classe.name }}</p>
                <p style="margin: 0 0 5px 0;"><strong>Niveau :</strong> {{ student.classe.level }}</p>
                <p style="margin: 0;"><strong>Semestre :</strong> {{ semester }}</p>
            </td>
        </tr>
    </table>

    <table class="grades-table">
        <thead>
            <tr>
                <th width="35%">Matière</th>
                <th width="10%">Coef</th>
                <th width="15%">Note /20</th>
                <th width="15%">Produit</th>
                <th width="25%">Observation</th>
            </tr>
        </thead>
        <tbody>
            {% set totalCoef = 0 %}
            {% set totalPoints = 0 %}
            {% for grade in grades %}
                {% set produit = grade.value * grade.subject.coefficient %}
                {% set totalCoef = totalCoef + grade.subject.coefficient %}
                {% set totalPoints = totalPoints + produit %}
                <tr>
                    <td>{{ grade.subject.name }}</td>
                    <td class="center">{{ grade.subject.coefficient }}</td>
                    <td class="center">{{ grade.value|number_format(2, ',', ' ') }}</td>
                    <td class="center">{{ produit|number_format(2, ',', ' ') }}</td>
                    <td style="font-style:italic; font-size:10px;">
                        {% if grade.value >= 14 %}Bien{% elseif grade.value >= 10 %}Passable{% else %}Faible{% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td class="right"><strong>TOTAL</strong></td>
                <td class="center"><strong>{{ totalCoef }}</strong></td>
                <td style="background-color:#ccc;"></td>
                <td class="center"><strong>{{ totalPoints|number_format(2, ',', ' ') }}</strong></td>
                <td></td>
            </tr>
            <tr class="avg-row">
                <td colspan="3" class="right">MOYENNE GÉNÉRALE</td>
                <td colspan="2" class="center">{{ (totalPoints / (totalCoef ?: 1))|number_format(2, ',', ' ') }} / 20</td>
            </tr>
        </tfoot>
    </table>

    <table style="width: 100%; margin-top: 30px; border-collapse: collapse;">
        <tr>
            <td style="width: 32%; border: 1px solid #000; height: 120px; vertical-align: top; padding: 8px; position: relative;">
                <strong style="text-decoration: underline; font-size: 10px;">Décision du Conseil :</strong><br><br>
                <div style="position: absolute; bottom: 8px; left: 8px; font-style: italic; font-size: 11px;">
                    {% if (totalPoints / (totalCoef ?: 1)) >= 10 %}
                        Admis(e)
                    {% else %}
                        Non Admis(e)
                    {% endif %}
                </div>
            </td>
            <td style="width: 2%; border: none;"></td>
            <td style="width: 32%; border: 1px solid #000; height: 120px; vertical-align: top; padding: 8px;">
                <strong style="text-decoration: underline; font-size: 10px;">Visa des Parents :</strong>
            </td>
            <td style="width: 2%; border: none;"></td>
            <td style="width: 32%; border: 1px solid #000; height: 120px; vertical-align: top; padding: 8px; text-align: center;">
                <strong style="text-decoration: underline; font-size: 10px;">Le Directeur :</strong><br><br>
                <div style="font-size: 10px; color: #666; font-style: italic; margin-top: 50px;">
                    (Cachet et Signature)
                </div>
            </td>
        </tr>
    </table>

    <div style="margin-top: 40px; text-align: center; font-size: 10px; color: #666;">
        Fait à Casablanca, le {{ "now"|date("d/m/Y") }}
    </div>
</body>
</html>
