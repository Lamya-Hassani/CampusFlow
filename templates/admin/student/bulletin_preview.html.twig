{% extends 'base.html.twig' %}

{% block body %}
<div class="max-w-4xl mx-auto">
    <!-- Toolbar -->
    <div class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
        <h2 class="font-bold text-slate-700">Aperçu du Bulletin (Semestre {{ semester }})</h2>
        <div>
            <a href="{{ path('admin_student_show', {'id': student.id}) }}" class="text-slate-500 font-bold mr-4 hover:text-slate-700">Retour</a>
            <a href="{{ path('admin_student_bulletin_pdf', {'id': student.id, 'semester': semester}) }}" 
               onclick="return confirm('Confirmer le téléchargement du PDF officiel ?')"
               class="bg-campus-yellow text-slate-900 px-6 py-2 rounded-full font-bold shadow-md hover:bg-yellow-300 transition-colors">
               <i class="fa-solid fa-download mr-2"></i> Télécharger PDF
            </a>
        </div>
    </div>

    <!-- THE PAPER (Simulates A4) -->
    <div class="bg-white p-[1cm] shadow-2xl mx-auto text-black" style="min-height: 29.7cm; width: 21cm; font-family: 'Times New Roman', serif;">
        
        <!-- Header -->
        <div class="text-center mb-8 border-b-2 border-black pb-4">
            <h3 class="uppercase font-bold text-sm tracking-widest mb-1">Royaume du Maroc</h3>
            <h4 class="uppercase font-bold text-xs">Ministère de l'Éducation Nationale</h4>
            <div class="flex justify-between items-end mt-6">
                <div class="text-left text-sm">
                    <p><strong>Établissement :</strong> CampusFlow Academy</p>
                    <p><strong>Année Scolaire :</strong> {{ student.classe.academicYear }}</p>
                </div>
                <div class="text-right text-sm">
                    <p><strong>Ville :</strong> Casablanca</p>
                </div>
            </div>
        </div>

        <!-- Student Info Box -->
        <div class="border border-black p-4 mb-6 flex justify-between bg-gray-50">
            <div>
                <p class="mb-1"><strong>Nom & Prénom :</strong> {{ student.lastName|upper }} {{ student.firstName }}</p>
                <p class="mb-1"><strong>N° CNE :</strong> {{ student.cne }}</p>
                <p><strong>Date de Naissance :</strong> {{ student.birthDate|date('d/m/Y') }}</p>
            </div>
            <div class="text-right">
                <p class="mb-1"><strong>Classe :</strong> {{ student.classe.name }}</p>
                <p><strong>Niveau :</strong> {{ student.classe.level }}</p>
                <p><strong>Semestre :</strong> {{ semester }}</p>
            </div>
        </div>

        <!-- Grades Table -->
        <table class="w-full border-collapse border border-black text-sm mb-6">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border border-black p-2 text-left w-1/3">Matière</th>
                    <th class="border border-black p-2 text-center w-16">Coef.</th>
                    <th class="border border-black p-2 text-center w-16">Note /20</th>
                    <th class="border border-black p-2 text-center w-16">Produit</th>
                    <th class="border border-black p-2 text-left">Appréciations / Observations</th>
                </tr>
            </thead>
            <tbody>
                {% set totalCoef = 0 %}
                {% set totalPoints = 0 %}
                
                {% for item in gradesData %}
                    {% set produit = item.grade.value * item.subject.coefficient %}
                    {% set totalCoef = totalCoef + item.subject.coefficient %}
                    {% set totalPoints = totalPoints + produit %}
                    
                    <tr>
                        <td class="border border-black p-2 font-bold">{{ item.subject.name }}</td>
                        <td class="border border-black p-2 text-center">{{ item.subject.coefficient }}</td>
                        <td class="border border-black p-2 text-center font-mono 
                            {% if item.grade.value < 10 %}text-red-600{% endif %}">
                            {{ item.grade.value|number_format(2, ',', ' ') }}
                        </td>
                        <td class="border border-black p-2 text-center font-mono">{{ produit|number_format(2, ',', ' ') }}</td>
                        <td class="border border-black p-2 text-xs italic text-gray-600">
                            {% if item.grade.value >= 16 %}Très Bien
                            {% elseif item.grade.value >= 14 %}Bien
                            {% elseif item.grade.value >= 12 %}Assez Bien
                            {% elseif item.grade.value >= 10 %}Passable
                            {% else %}Insuffisant{% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="bg-gray-100 font-bold">
                    <td class="border border-black p-2 text-right uppercase">Total</td>
                    <td class="border border-black p-2 text-center">{{ totalCoef }}</td>
                    <td class="border border-black p-2 bg-gray-300"></td>
                    <td class="border border-black p-2 text-center">{{ totalPoints|number_format(2, ',', ' ') }}</td>
                    <td class="border border-black p-2"></td>
                </tr>
                <tr class="bg-blue-50">
                    <td colspan="3" class="border border-black p-3 text-right uppercase font-bold text-lg">Moyenne Générale</td>
                    <td colspan="2" class="border border-black p-3 text-center font-bold text-xl text-blue-900">
                        {{ (totalPoints / (totalCoef ?: 1))|number_format(2, ',', ' ') }} / 20
                    </td>
                </tr>
            </tfoot>
        </table>

        <!-- Signatures Area -->
        <div class="grid grid-cols-3 gap-4 mt-12 h-40">
            <div class="border border-black p-2 h-full relative">
                <p class="text-xs font-bold underline mb-2">Décision du Conseil :</p>
                <div class="absolute bottom-2 left-2 text-xs italic">
                    {% if (totalPoints / (totalCoef ?: 1)) >= 10 %}
                        Admis(e)
                    {% else %}
                        Non Admis(e)
                    {% endif %}
                </div>
            </div>
            <div class="border border-black p-2 h-full">
                <p class="text-xs font-bold underline mb-2">Visa des Parents :</p>
            </div>
            <div class="border border-black p-2 h-full text-center">
                <p class="text-xs font-bold underline mb-8">Le Directeur :</p>
                <p class="text-xs text-gray-400 italic">(Cachet et Signature)</p>
            </div>
        </div>

        <div class="mt-8 text-center text-xs text-gray-500">
            Fait à Casablanca, le {{ "now"|date("d/m/Y") }}
        </div>
    </div>
</div>
{% endblock %}