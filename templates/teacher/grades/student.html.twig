{% extends 'base.html.twig' %}

{% block title %}
  Notes de {{ student.fullName }} - CampusFlow
{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <style>
    /* --- 1. Custom Scrollbar --- */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- 2. Animations --- */
    @keyframes blob {
        0% { transform: translate(0px, 0px) scale(1); }
        33% { transform: translate(30px, -50px) scale(1.1); }
        66% { transform: translate(-20px, 20px) scale(0.9); }
        100% { transform: translate(0px, 0px) scale(1); }
    }
    .animate-blob { animation: blob 7s infinite; }
    .animation-delay-2000 { animation-delay: 2s; }
    .animation-delay-4000 { animation-delay: 4s; }

    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-up {
        opacity: 0; /* Hidden initially for JS observer */
        animation: fadeUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    /* --- 3. Glass & Hover Effects --- */
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
    }
    
    .table-row-hover {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .table-row-hover:hover {
        transform: scale(1.01) translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        z-index: 10;
        position: relative;
        background-color: #fff;
    }
  </style>
{% endblock %}

{% block body %}
  <div class="bg-[#F7F5F2] text-[#264653] antialiased min-h-screen">
    
    {# ============================================
       1. HERO HEADER (Full Width & Premium)
       ============================================ #}
    <!-- Full width background container -->
    <div class="relative bg-[#264653] pb-32 pt-10 rounded-b-[3rem] shadow-2xl overflow-hidden mb-12">
        
        <!-- Animated Background Blobs -->
        <div class="absolute top-0 -left-4 w-96 h-96 bg-[#3A86FF] rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-96 h-96 bg-[#F4C095] rounded-full mix-blend-multiply filter blur-3xl opacity-40 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-96 h-96 bg-[#FF7F50] rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
        
        <!-- Texture Overlay -->
        <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>

        <!-- Content Container -->
        <div class="max-w-7xl mx-auto px-6 md:px-10 relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6 animate-fade-up">
          
          {# Back button + Student Info #}
          <div class="flex items-center gap-6">
            <a href="{{ path('teacher_grades_students') }}" class="group flex items-center justify-center w-12 h-12 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white hover:bg-[#FF7F50] hover:border-[#FF7F50] transition-all duration-300 shadow-lg">
                <i class="fas fa-arrow-left text-sm group-hover:-translate-x-1 transition-transform"></i>
            </a>

            <div class="flex items-center gap-5">
              <!-- Avatar with Ring -->
              <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-[#3A86FF] to-[#264653] flex items-center justify-center text-white font-heading font-bold text-3xl shadow-lg border-4 border-white/10">
                {{ student.firstName|first }}{{ student.lastName|first }}
              </div>

              <div>
                <h1 class="font-heading text-4xl font-bold text-white tracking-tight leading-tight">
                  {{ student.fullName ?? (student.firstName ~ ' ' ~ student.lastName) }}
                </h1>
                <div class="flex items-center gap-3 mt-2 text-[#88C9E8] text-sm font-medium">
                  <span class="bg-white/10 px-3 py-1 rounded-full border border-white/10 backdrop-blur-sm text-[#F4C095]">
                    <i class="fas fa-graduation-cap mr-1.5"></i> {{ student.classe.name }}
                  </span>
                  <span class="opacity-80"><i class="fas fa-id-card mr-1.5"></i>ID: {{ student.id }}</span>
                </div>
              </div>
            </div>
          </div>

          {# CTA: Add Grade #}
          <div>
            <a href="{{ path('teacher_grades_add_for_student', { id: student.id }) }}" class="flex items-center gap-2 px-6 py-3 bg-[#FF7F50] text-white font-bold rounded-xl shadow-lg shadow-[#FF7F50]/30 hover:shadow-[#FF7F50]/50 hover:-translate-y-1 hover:bg-[#ff8a60] transition-all duration-300 group">
              <div class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-white group-hover:rotate-90 transition-transform">
                <i class="fas fa-plus text-xs"></i>
              </div>
              <span>Ajouter une note</span>
            </a>
          </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto pb-12">
      {# ============================================
         2. CONTENT (Overlapping Hero)
         ============================================ #}
      <div class="px-6 md:px-10 -mt-24 relative z-20">
        
        {# Summary cards #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 animate-fade-up" style="animation-delay: 150ms;">
          
          <!-- Card 1: Total -->
          <div class="glass-card p-6 rounded-2xl flex items-center justify-between group hover:-translate-y-2 transition-transform duration-300">
            <div>
              <p class="text-[#264653]/60 text-xs font-bold uppercase tracking-wider mb-1">Total évaluations</p>
              <p class="text-4xl font-heading font-extrabold text-[#264653] counter-anim" data-target="{{ grades|length }}">0</p>
            </div>
            <div class="w-14 h-14 rounded-2xl bg-[#3A86FF]/10 text-[#3A86FF] flex items-center justify-center text-2xl group-hover:scale-110 group-hover:bg-[#3A86FF] group-hover:text-white transition-all">
              <i class="fas fa-clipboard-list"></i>
            </div>
          </div>

          <!-- Card 2: Placeholder for Average -->
          <div class="glass-card p-6 rounded-2xl flex items-center justify-between opacity-70 grayscale cursor-not-allowed border-dashed border-[#264653]/20" title="Calcul automatique bientôt disponible">
            <div>
              <p class="text-[#264653]/50 text-xs font-bold uppercase tracking-wider mb-1">Moyenne générale</p>
              <p class="text-4xl font-heading font-extrabold text-[#264653]/30">--</p>
            </div>
            <div class="w-14 h-14 rounded-2xl bg-[#264653]/5 text-[#264653]/30 flex items-center justify-center text-2xl">
              <i class="fas fa-chart-pie"></i>
            </div>
          </div>
        </div>

        {# ============================================
           3. GRADES TABLE (Modern & Interactive)
           ============================================ #}
        <div class="bg-white rounded-[2rem] shadow-xl shadow-[#264653]/5 border border-[#264653]/5 overflow-hidden animate-fade-up" style="animation-delay: 300ms;">
          <div class="overflow-x-auto no-scrollbar">
            <table class="w-full text-left border-collapse">
              <thead>
                <tr class="bg-[#F7F5F2] border-b border-[#264653]/10">
                  <th class="py-5 px-8 text-xs font-bold uppercase tracking-wider text-[#264653]/60 whitespace-nowrap">Matière / Module</th>
                  <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-[#264653]/60 whitespace-nowrap">Type</th>
                  <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-[#264653]/60 whitespace-nowrap">Semestre</th>
                  <th class="py-5 px-6 text-xs font-bold uppercase tracking-wider text-[#264653]/60 whitespace-nowrap text-center">Note / 20</th>
                  <th class="py-5 px-8 text-xs font-bold uppercase tracking-wider text-[#264653]/60 whitespace-nowrap text-right">Date</th>
                </tr>
              </thead>

              <tbody class="divide-y divide-[#264653]/5">
                {% for grade in grades %}
                  {# Color Logic for "Wow" Effect #}
                  {% set badgeClass = 'bg-[#F7F5F2] text-[#264653] border-[#264653]/20' %}
                  {% set scoreClass = 'text-[#264653]' %}
                  
                  {% if grade.value < 10 %}
                    {# Fail: Red + Pulse #}
                    {% set badgeClass = 'bg-rose-50 text-rose-600 border-rose-100 ring-2 ring-rose-50' %}
                    {% set scoreClass = 'text-rose-600' %}
                  {% elseif grade.value < 14 %}
                    {# Average: Amber #}
                    {% set badgeClass = 'bg-amber-50 text-amber-600 border-amber-100' %}
                    {% set scoreClass = 'text-amber-600' %}
                  {% else %}
                    {# Good: Teal + Shine #}
                    {% set badgeClass = 'bg-[#2A9D8F]/10 text-[#2A9D8F] border-[#2A9D8F]/20' %}
                    {% set scoreClass = 'text-[#2A9D8F]' %}
                  {% endif %}

                  <tr class="group table-row-hover animate-fade-up" style="animation-delay: {{ 300 + loop.index0 * 50 }}ms;">
                    <!-- Subject -->
                    <td class="py-5 px-8">
                      <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-[#88C9E8]/20 text-[#264653] flex items-center justify-center group-hover:bg-[#FF7F50] group-hover:text-white group-hover:rotate-3 transition-all duration-300">
                          <i class="fas fa-book-open text-sm"></i>
                        </div>
                        <div>
                          <p class="font-bold text-[#264653] text-sm group-hover:text-[#FF7F50] transition-colors">{{ grade.subject.name }}</p>
                        </div>
                      </div>
                    </td>

                    <!-- Type -->
                    <td class="py-5 px-6">
                      <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-white border border-[#264653]/10 text-[#264653]/70 shadow-sm group-hover:border-[#FF7F50]/30 transition-colors">
                        {{ grade.type }}
                      </span>
                    </td>

                    <!-- Semester -->
                    <td class="py-5 px-6 text-sm font-medium text-[#264653]/60">
                        S{{ grade.semester }}
                    </td>

                    <!-- Grade (Centerpiece) -->
                    <td class="py-5 px-6 text-center">
                      <span class="inline-block px-5 py-2 rounded-xl text-base font-bold border {{ badgeClass }} shadow-sm {{ scoreClass }} group-hover:scale-110 transition-transform">
                        {{ grade.value }}
                      </span>
                    </td>

                    <!-- Date -->
                    <td class="py-5 px-8 text-right text-sm text-[#264653]/50 font-medium font-mono">
                        {{ grade.createdAt|date('d M Y') }}
                    </td>
                  </tr>
                {% else %}
                  <!-- Empty State -->
                  <tr>
                    <td colspan="5" class="py-20 text-center">
                      <div class="flex flex-col items-center justify-center animate-fade-up" style="animation-delay: 200ms;">
                        <div class="w-24 h-24 bg-[#F7F5F2] rounded-full flex items-center justify-center mb-6 shadow-inner animate-blob">
                          <i class="fas fa-clipboard-check text-4xl text-[#264653]/20"></i>
                        </div>
                        <h3 class="text-xl font-bold text-[#264653] mb-2">Aucune note enregistrée</h3>
                        <p class="text-[#264653]/50 text-sm mb-8 max-w-xs mx-auto">Cet étudiant n'a pas encore reçu d'évaluation pour cette période.</p>
                        <a href="{{ path('teacher_grades_add_for_student', { id: student.id }) }}" class="inline-block px-6 py-2 border-2 border-[#FF7F50] text-[#FF7F50] font-bold rounded-full hover:bg-[#FF7F50] hover:text-white transition-colors duration-300">
                            Ajouter une première note
                        </a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          {% if (grades|length) > 0 %}
            <div class="bg-[#F7F5F2] border-t border-[#264653]/10 px-8 py-4 flex justify-between items-center text-xs font-medium text-[#264653]/60">
              <span>Affichage de {{ grades|length }} résultats</span>
              <span class="flex items-center gap-2">
                <i class="fas fa-info-circle text-[#88C9E8]"></i>
                Note <span class="w-2 h-2 rounded-full bg-rose-500 inline-block"></span> &lt; 10
              </span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {# ==========================================
     JAVASCRIPT FOR ANIMATIONS
     ========================================== #}
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. Observer for Fade-Up Animations
        const observerOptions = { threshold: 0.1 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.animationPlayState = 'running';
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.animate-fade-up').forEach(el => {
            observer.observe(el);
        });

        // 2. Count Up Animation
        const counters = document.querySelectorAll('.counter-anim');
        counters.forEach(counter => {
            counter.innerText = '0';
            const target = +counter.dataset.target;
            const duration = 1000;
            const increment = target / (duration / 16); 

            if(target > 0) {
                let current = 0;
                const update = () => {
                    current += increment;
                    if(current < target) {
                        counter.innerText = Math.ceil(current);
                        requestAnimationFrame(update);
                    } else {
                        counter.innerText = target;
                    }
                };
                setTimeout(update, 500); // Start after fade-in
            }
        });
    });
  </script>
{% endblock %}
